import 'dart:typed_data';

import 'package:dartls/src/tls/cipher.dart';
import 'package:dartls/src/tls/tls_random.dart';

import '../../../types/types.dart';
import '../extensions/extensions.dart';
import '../misc.dart';
import '../protocol_version.dart';

class ClientHello {
  ProtocolVersion protocolVersion;
  TlsRandom tlsRandom;
  Uint8List sessionId;
  // Uint8List cookie;
  List<int> cipherSuiteList;
  List<int> compressionMethods;
  List<Extension> extensions;

  ClientHello(this.protocolVersion, this.tlsRandom, this.sessionId,
      this.cipherSuiteList, this.compressionMethods, this.extensions);
  factory ClientHello.unmarshal(Uint8List data, int offset, int arrayLen) {
    final reader = ByteData.sublistView(data);

    ProtocolVersion protocolVersion =
        ProtocolVersion(Uint8(data[offset]), Uint8(data[offset + 1]));
    offset += 2;
    TlsRandom tlsRandom = TlsRandom.unmarshal(data, offset, arrayLen);
    offset += 32;

    final sessionIdLength = reader.getUint8(offset);
    offset += 1;
    // print("Session id length: $session_id_length");

    final sessionId = sessionIdLength > 0
        ? data.sublist(offset, offset + sessionIdLength)
        : Uint8List(0);
    offset += sessionId.length;

    // final cookieLength = data[offset];
    // offset += 1;

    // final cookie = data.sublist(offset, offset + cookieLength);
    // offset += cookie.length;
    var (cipherSuiteList, decodedOffset) =
        decodeCipherSuites(data, offset, arrayLen);
    offset = decodedOffset;

    var (compressionMethods, decodedCompOffset) =
        decodeCompressionMethodIDs(data, offset, arrayLen);
    offset = decodedCompOffset;

    var (extensions, decodedExtensions) =
        decodeExtensions(data, offset, arrayLen);

    offset = decodedExtensions;

    return ClientHello(protocolVersion, tlsRandom, sessionId, cipherSuiteList,
        compressionMethods, extensions);
  }

  @override
  String toString() {
    // TODO: implement toString
    return """ClientHello(client_version: $protocolVersion,
        random: $tlsRandom,
        session_id: $sessionId, 
        ciphers: $cipherSuiteList,
        compression methods: $compressionMethods,
        extensions: $extensions
        """;

// """
//        cipher_suites_length: $cipher_suites_length,
//        cipher_suites: ${cipher_suites},
//        compression_methods_length: $compression_methods_length,
//        compression_methods: $compression_methods,
//        extensions: $extensions)
//        """;
  }
}

// Received: [22, 3, 1, 7, 0, 1, 0, 6, 252, 3, 3, 150, 70, 176, 181, 124, 196, 150, 215, 183, 202, 111, 163, 191, 120, 76, 87, 213, 80, 191, 128, 14, 72, 50, 125, 165, 253, 223, 5, 254, 104, 229, 145, 32, 192, 84, 3, 162, 163, 57, 79, 209, 110, 90, 47, 231, 48, 57, 234, 79, 122, 48, 158, 42, 218, 141, 51, 4, 42, 140, 32, 82, 46, 117, 144, 67, 0, 32, 202, 202, 19, 1, 19, 2, 19, 3, 192, 43, 192, 47, 192, 44, 192, 48, 204, 169, 204, 168, 192, 19, 192, 20, 0, 156, 0, 157, 0, 47, 0, 53, 1, 0, 6, 147, 186, 186, 0, 0, 0, 16, 0, 14, 0, 12, 2, 104, 50, 8, 104, 116, 116, 112, 47, 49, 46, 49, 0, 43, 0, 7, 6, 138, 138, 3, 4, 3, 3, 254, 13, 1, 26, 0, 0, 1, 0, 1, 193, 0, 32, 135, 132, 17, 215, 164, 22, 171, 50, 238, 56, 127, 10, 227, 76, 168, 114, 100, 67, 136, 33, 224, 38, 92, 35, 112, 29, 84, 210, 122, 21, 80, 66, 0, 240, 104, 202, 232, 87, 141, 175, 59, 101, 118, 162, 184, 71, 62, 109, 219, 93, 66, 211, 120, 90, 54, 240, 48, 84, 197, 158, 125, 63, 120, 180, 207, 187, 15, 124, 81, 90, 140, 0, 77, 41, 175, 8, 24, 80, 8, 31, 176, 0, 25, 19, 164, 104, 113, 116, 192, 254, 6, 144, 40, 7, 247, 99, 43, 112, 196, 238, 251, 64, 192, 154, 147, 226, 157, 122, 180, 189, 46, 169, 162, 45, 32, 107, 218, 168, 113, 40, 84, 198, 56, 2, 180, 61, 101, 129, 166, 17, 188, 193, 29, 213, 224, 163, 122, 32, 227, 134, 173, 68, 178, 243, 209, 150, 147, 1, 33, 227, 35, 196, 232, 120, 202, 63, 54, 254, 60, 172, 34, 45, 129, 204, 71, 177, 134, 198, 245, 157, 212, 207, 244, 149, 15, 154, 53, 133, 133, 211, 117, 147, 51, 77, 147, 214, 31, 188, 225, 174, 185, 251, 235, 133, 85, 221, 180, 144, 30, 34, 204, 152, 11, 57, 82, 7, 136, 229, 74, 152, 66, 210, 69, 222, 110, 43, 148, 171, 108, 186, 39, 161, 109, 38, 20, 220, 185, 94, 70, 107, 234, 185, 1, 146, 249, 24, 15, 36, 110, 11, 57, 184, 68, 227, 55, 10, 235, 62, 239, 110, 49, 44, 51, 92, 28, 36, 193, 79, 162, 242, 212, 131, 111, 153, 195, 231, 14, 113, 236, 22, 156, 55, 1, 208, 0, 5, 0, 5, 1, 0, 0, 0, 0, 0, 45, 0, 2, 1, 1, 0, 27, 0, 3, 2, 0, 2, 0, 11, 0, 2, 1, 0, 0, 10, 0, 12, 0, 10, 106, 106, 17, 236, 0, 29, 0, 23, 0, 24, 0, 51, 4, 239, 4, 237, 106, 106, 0, 1, 0, 17, 236, 4, 192, 112, 235, 27, 6, 180, 132, 198, 184, 97, 40, 41, 142, 163, 119, 15, 193, 194, 64, 89, 89, 77, 92, 53, 29, 22, 251, 181, 70, 138, 107, 135, 121, 92, 251, 224, 64, 104, 98, 147, 202, 88, 27, 26, 146, 37, 79, 162, 205, 66, 70, 109, 133, 170, 86, 184, 161, 115, 11, 83, 82, 210, 16, 9, 248, 66, 180, 25, 180, 1, 71, 247, 166, 109, 149, 124, 248, 50, 64, 196, 154, 81, 42, 148, 148, 24, 17, 72, 63, 19, 107, 65, 202, 153, 46, 56, 127, 248, 154, 187, 44, 118, 36, 104, 10, 161, 200, 167, 114, 54, 215, 32, 42, 203, 42, 148, 162, 201, 228, 56, 10, 207, 24, 204, 46, 73, 70, 202, 156, 188, 147, 121, 107, 251, 54, 199, 22, 156, 190, 97, 42, 142, 140, 22, 21, 145, 129, 114, 189, 208, 25, 178, 39, 141, 3, 2, 189, 184, 35, 89, 223, 114, 29, 11, 220, 41, 181, 136, 8, 90, 19, 101, 46, 75, 206, 144, 153, 63, 107, 153, 139, 39, 134, 119, 139, 90, 61, 51, 160, 107, 218, 40, 165, 29, 233, 82, 199, 58, 44, 205, 54, 96, 121, 199, 71, 131, 120, 89, 205, 194, 154, 198, 148, 18, 183, 57, 130, 16, 130, 13, 155, 57, 194, 85, 227, 16, 69, 105, 73, 238, 116, 159, 213, 177, 120, 67, 149, 54, 84, 228, 189, 184, 11, 14, 232, 171, 40, 187, 112, 164, 255, 211, 65, 131, 28, 153, 98, 0, 95, 199, 92, 21, 90, 234, 176, 41, 39, 15, 163, 136, 102, 116, 84, 156, 242, 99, 88, 106, 241, 44, 56, 138, 57, 14, 251, 95, 8, 2, 121, 47, 129, 100, 53, 52, 116, 150, 226, 149, 64, 76, 22, 21, 20, 74, 1, 246, 147, 47, 214, 198, 151, 65, 160, 138, 68, 182, 148, 251, 187, 194, 179, 93, 198, 19, 121, 197, 161, 26, 37, 186, 206, 213, 24, 103, 200, 6, 160, 169, 211, 39, 177, 216, 198, 104, 247, 146, 206, 19, 206, 66, 230, 115, 2, 155, 157, 51, 242, 102, 1, 123, 148, 165, 19, 66, 213, 67, 197, 200, 133, 146, 194, 102, 15, 57, 249, 199, 43, 229, 156, 245, 181, 22, 97, 195, 189, 225, 12, 57, 181, 49, 33, 218, 85, 122, 164, 167, 68, 140, 151, 40, 133, 247, 192, 114, 227, 121, 43, 80, 93, 20, 148, 63, 223, 248, 190, 228, 55, 17, 154, 129, 59, 167, 181, 41, 249, 144, 103, 52, 178, 120, 129, 16, 108, 0, 76, 5, 53, 18, 85, 145, 133, 128, 211, 161, 200, 0, 72, 202, 242, 33, 18, 151, 170, 196, 66, 227, 136, 241, 169, 110, 33, 193, 112, 183, 186, 205, 15, 144, 127, 165, 89, 89, 117, 83, 204, 175, 103, 52, 13, 229, 183, 124, 81, 197, 109, 96, 172, 29, 167, 149, 48, 197, 97, 92, 33, 147, 249, 59, 99, 62, 89, 115, 144, 145, 87, 11, 54, 50, 221, 226, 80, 146, 248, 152, 250, 247, 92, 50, 161, 151, 124, 250, 35, 185, 119, 67, 170, 146, 64, 23, 169, 64, 249, 24, 194, 63, 88, 7, 60, 230, 140, 174, 74, 180, 253, 226, 30, 8, 163, 22, 59, 243, 179, 101, 8, 30, 230, 6, 135, 62, 133, 141, 47, 160, 167, 40, 209, 22, 133, 248, 51, 169, 181, 98, 41, 148, 96, 119, 51, 31, 211, 164, 144, 195, 53, 202, 207, 155, 164, 114, 251, 55, 172, 76, 177, 46, 188, 161, 237, 25, 197, 174, 32, 57, 71, 150, 184, 65, 75, 136, 167, 17, 118, 15, 130, 163, 231, 33, 188, 176, 59, 18, 231, 150, 73, 124, 6, 133, 178, 17, 164, 247, 122, 86, 67, 51, 27, 108, 249, 69, 167, 131, 127, 84, 144, 20, 137, 5, 149, 150, 48, 66, 103, 84, 167, 29, 183, 36, 99, 148, 179, 247, 170, 150, 16, 203, 69, 45, 169, 93, 163, 224, 66, 137, 196, 63, 24, 187, 60, 3, 251, 150, 149, 115, 144, 240, 0, 12, 248, 176, 107, 206, 235, 24, 63, 138, 90, 21, 194, 28, 33, 37, 57, 225, 20, 51, 22, 2, 203, 183, 116, 172, 211, 220, 7, 155, 181, 28, 124, 183, 72, 34, 16, 70, 141, 91, 43, 203, 25, 154, 157, 3, 189, 187, 162, 152, 89, 203, 181, 112, 82, 97, 189, 21, 27, 155, 171, 178, 160, 21, 161, 13, 169, 73, 135, 36, 189, 116, 7, 70, 124, 170, 103, 210, 224, 18, 133, 200, 13, 149, 35, 67, 152, 91, 134, 82, 146, 78, 69, 38, 125, 0, 156, 175, 13, 67, 202, 68, 97, 181, 67, 246, 121, 8, 164, 69, 138, 70, 39, 38, 48, 187, 139, 73, 163, 176, 9, 176, 47, 73, 80, 162, 161, 87, 126, 83, 62, 173, 98, 80, 55, 88, 87, 35, 166, 202, 83, 97, 22, 138, 135, 196, 237, 72, 46, 174, 138, 42, 122, 83, 28, 77, 181, 101, 21, 5, 29, 8, 50, 12, 220, 188, 82, 8, 56, 113, 93, 24, 64, 242, 161, 118, 13, 212, 151, 38, 11, 177, 32, 228, 24, 141, 140, 178, 194, 198, 113, 88, 49, 149, 0, 200, 30, 49, 37, 167, 188, 165, 40, 202, 154, 96, 191, 229, 87, 218, 129, 150, 125, 87, 18, 34, 57, 54, 66, 144, 168, 98, 150, 158, 220, 166, 120, 132, 113, 132, 144, 59, 185, 242, 18, 81, 79, 230, 57, 60, 167, 94, 237, 244, 127, 183, 136, 11, 215, 57, 1, 162, 48, 47, 11, 171, 177, 124, 212, 33, 215, 40, 102, 58, 16, 64, 155, 36, 5, 162, 92, 195, 208, 184, 181, 13, 131, 154, 128, 155, 176, 179, 211, 21, 114, 177, 133, 193, 140, 164, 37, 235, 195, 47, 247, 145, 145, 60, 136, 246, 25, 77, 32, 0, 67, 5, 208, 88, 8, 225, 32, 38, 90, 52, 90, 145, 122, 115, 74, 205, 29, 229, 10, 45, 252, 170, 207, 240, 149, 111, 88, 53, 128, 177, 148, 15, 211, 163, 25, 107, 54, 137, 230, 93, 251, 7, 67, 108, 154, 152, 30, 147, 67, 107, 244, 207, 111, 242, 13, 106, 26, 69, 71, 129, 6, 204, 165, 167, 0, 147, 180, 126, 180, 165, 226, 152, 60, 102, 179, 52, 103, 146, 189, 66, 119, 148, 39, 154, 140, 216, 83, 203, 70, 135, 29, 172, 83, 94, 251, 198, 39, 237, 89, 187, 131, 69, 160, 126, 227, 39, 38, 44, 146, 1, 107, 141, 138, 226, 60, 87, 152, 140, 198, 67, 186, 137, 166, 48, 215, 58, 125, 3, 26, 112, 199, 179, 98, 180, 26, 28, 145, 124, 163, 97, 232, 19, 24, 178, 84, 79, 148, 108, 229, 154, 67, 31, 113, 2, 51, 50, 133, 66, 121, 118, 41, 27, 201, 166, 247, 221, 43, 33, 129, 74, 64, 75, 128, 135, 20, 201, 57, 161, 118, 196, 107, 161, 218, 237, 163, 80, 9, 55, 124, 212, 61, 112, 140, 230, 101, 2, 172, 35, 71, 190, 199, 55, 134, 189, 14, 218, 248, 168, 225, 140, 182, 103, 52, 111, 236, 242, 190, 193, 126, 172, 242, 29, 125, 210, 111, 41, 67, 0, 29, 0, 32, 253, 7, 200, 165, 99, 79, 204, 222, 194, 1, 113, 118, 30, 125, 125, 45, 22, 166, 171, 48, 222, 192, 103, 145, 133, 208, 192, 86, 205, 110, 178, 25, 0, 35, 0, 0, 0, 13, 0, 18, 0, 16, 4, 3, 8, 4, 4, 1, 5, 3, 8, 5, 5, 1, 8, 6, 6, 1, 0, 18, 0, 0, 0, 23, 0, 0, 255, 1, 0, 1, 0, 68, 105, 0, 5, 0, 3, 2, 104, 50, 122, 122, 0, 1, 0]
